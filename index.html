<script>
    function generateCode() {
        // Формируем чистую прямую ссылку на файлы GitHub
        const gh = document.getElementById('ghPath').value
            .replace('github.io/', 'raw.githubusercontent.com/')
            .replace('/AUDIOPLAYER1/', '/AUDIOPLAYER1/main/');
            
        const c1 = document.getElementById('clr1').value;
        const c2 = document.getElementById('clr2').value;
        const lang = document.getElementById('lang').value;
        const rawTracks = document.getElementById('tracks').value.split('\n').filter(t => t.includes('|'));
        
        const trackList = rawTracks.map(t => {
            const p = t.split('|');
            return { n: p[0].trim(), f: p[1].trim() };
        });

        const i18n = {
            ru: { list: "ПЛЕЙЛИСТ", rnd: "РАНДОМ", vol: "ГРОМК.", none: "НЕТ ФАЙЛА" },
            de: { list: "LISTE", rnd: "ZUFALL", vol: "LAUTS.", none: "KEINE DATEI" },
            en: { list: "PLAYLIST", rnd: "SHUFFLE", vol: "VOL.", none: "NO FILE" }
        }[lang];

        // Генерируем "чистый" HTML код для плеера
        const finalCode = `<!DOCTYPE html>
<html lang="${lang}">
<head>
<meta charset="UTF-8">
<style>
    :root { --p: ${c1}; --s: ${c2}; }
    body { background: transparent; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
    .player-body { width: 480px; height: 270px; background: rgba(26, 24, 23, 0.95); border: 4px solid #2d2a28; border-radius: 20px; display: flex; padding: 15px; box-sizing: border-box; position: relative; color: white; }
    .left-part { width: 160px; border-right: 1px solid #333; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .vinyl { width: 125px; height: 125px; border-radius: 50%; background: radial-gradient(circle, #222 10%, #111 15%, #000 70%); border: 5px solid #111; position: relative; animation: rotate 4s linear infinite; animation-play-state: paused; }
    .vinyl::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background: conic-gradient(var(--p), var(--s), var(--p)); opacity: 0.3; }
    @keyframes rotate { from {transform: rotate(0deg);} to {transform: rotate(360deg);} }
    .right-part { flex: 1; padding-left: 15px; display: flex; flex-direction: column; }
    .screen { background: #050505; border: 2px solid #222; border-radius: 12px; padding: 12px; flex: 1; display: flex; flex-direction: column; }
    .track-name { color: var(--p); font-size: 10px; text-transform: uppercase; height: 14px; overflow: hidden; font-family: monospace; }
    .timer { color: var(--s); font-size: 24px; font-weight: bold; margin: 5px 0; font-family: monospace; }
    .visualizer { display: flex; align-items: flex-end; gap: 2px; height: 35px; margin: 5px 0; }
    .bar { flex: 1; background: var(--s); height: 2px; transition: 0.1s; box-shadow: 0 0 5px var(--s); }
    .controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px; }
    .btn { background: #252321; border: 1px solid #3d3b39; color: var(--s); padding: 8px; cursor: pointer; border-radius: 6px; font-size: 9px; font-weight: bold; }
    .btn.active { color: var(--p); border-color: var(--p); }
    #playlist-window { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.96); display: none; padding: 20px; box-sizing: border-box; z-index: 10; border-radius: 20px; }
</style>
</head>
<body>
    <div class="player-body">
        <div class="left-part"><div class="vinyl" id="v-disk"></div></div>
        <div class="right-part">
            <div class="screen">
                <div class="track-name" id="t-title">${i18n.none}</div>
                <div class="timer" id="t-clock">00:00</div>
                <div class="visualizer" id="viz"></div>
            </div>
            <div class="controls">
                <button class="btn" onclick="chTrack(-1)">⏮</button>
                <button class="btn" id="p-play" onclick="playPause()">▶</button>
                <button class="btn" onclick="chTrack(1)">⏭</button>
                <button class="btn" onclick="togglePL()">${i18n.list}</button>
                <button class="btn" id="btn-rnd" onclick="toggleRnd()" style="grid-column: span 2;">${i18n.rnd}</button>
                <button class="btn" onclick="location.reload()" style="grid-column: span 2;">RESET</button>
            </div>
        </div>
        <div id="playlist-window">
            <div style="display:flex; justify-content: space-between; color:var(--p); font-size: 12px; margin-bottom:10px;"><b>${i18n.list}</b><span onclick="togglePL()" style="cursor:pointer;">✕</span></div>
            <div id="list-content" style="overflow-y:auto; height:180px; font-size:12px;"></div>
        </div>
    </div>
<script>
    const base = "${gh}";
    const tracks = ${JSON.stringify(trackList)};
    let cur = 0, isP = false, isR = false;
    const audio = new Audio();
    const disk = document.getElementById('v-disk'), btnP = document.getElementById('p-play'), viz = document.getElementById('viz');
    for(let i=0; i<25; i++) { let b=document.createElement('div'); b.className='bar'; viz.appendChild(b); }
    function loadTrack(i) {
        if(!tracks[i]) return;
        cur = i;
        audio.src = tracks[cur].f.includes('://') ? tracks[cur].f : base + tracks[cur].f;
        document.getElementById('t-title').innerText = tracks[cur].n;
    }
    function playPause() {
        if(isP) { audio.pause(); btnP.innerText="▶"; disk.style.animationPlayState="paused"; }
        else { audio.play().then(()=>{ btnP.innerText="⏸"; disk.style.animationPlayState="running"; }).catch(e=>alert("Файл не найден!")); }
        isP = !isP;
    }
    function chTrack(dir) {
        if(isR) cur = Math.floor(Math.random()*tracks.length);
        else cur = (cur + dir + tracks.length) % tracks.length;
        loadTrack(cur); if(isP) audio.play();
    }
    function toggleRnd() { isR = !isR; document.getElementById('btn-rnd').classList.toggle('active', isR); }
    function togglePL() {
        const w = document.getElementById('playlist-window');
        w.style.display = w.style.display === 'block' ? 'none' : 'block';
        document.getElementById('list-content').innerHTML = tracks.map((t,i) => \`<div onclick="loadTrack(\${i});playPause();togglePL();" style="padding:8px; border-bottom:1px solid #222; cursor:pointer; color:\${i===cur?'var(--p)':'var(--s)'}">\${t.n}</div>\`).join('');
    }
    audio.ontimeupdate = () => {
        let m = Math.floor(audio.currentTime/60), s = Math.floor(audio.currentTime%60);
        document.getElementById('t-clock').innerText = \`\${m}:\${s<10?'0':''}\${s}\`;
        if(isP) document.querySelectorAll('.bar').forEach(b => b.style.height = (Math.random()*30 + 2) + "px");
    };
    audio.onended = () => chTrack(1);
    loadTrack(0);
<\/script>
</body>
</html>`;

        // Обновляем окно кода
        document.getElementById('codeOut').value = finalCode;

        // ИСПРАВЛЕНИЕ ПРЕДПРОСМОТРА: используем Base64 для iframe
        const base64 = btoa(unescape(encodeURIComponent(finalCode)));
        document.getElementById('preview').innerHTML = `<iframe style="width:500px; height:300px; border:none;" src="data:text/html;base64,${base64}"></iframe>`;
        
        document.getElementById('modal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }
</script>
